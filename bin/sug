#!/bin/bash

PREFIX="/home/dafu/Lab"

GIT_REPO=(
        "amazon-freertos"
        "darwin-xnu"
        "f9-kernel"
        "leshan"
        "linux"
        "lwip-contrib"
        "mbed-cli"
        "mbed-client"
        "mbed-coap"
        "mbed-os"
        "mbedtls"
        "mcuboot"
        "netty-4.1.20.Final"
        "openssl"
        "uvisor"
        "wolfmqtt-0.14.0"
        "zephyr"
        "zircon"
        )

for git_repo in ${GIT_REPO[@]}; do
    if [ -f "$PREFIX/$git_repo" ]; then
        continue
    fi

    pushd "$PREFIX/$git_repo" >& /dev/null
    if [ "$?" != "0" ]; then
        continue
    fi

    if [ -e .git ]; then
        echo "[ CHECKING ] $PREFIX/$git_repo"
        eval "git pull --no-stat | grep \"Already up-to-date\.\""
        ret=$?
        if [ "$ret" == "1" ]; then
            echo "[ INDEXING ] $PREFIX/$git_repo"
            cscope -Rkb >& /dev/null
            ctags -R >& /dev/null
            echo "[  UPDATE  ] $PREFIX/$git_repo"
        else
            if [ "$1" == "-f" ]; then
                echo "[ INDEXING ] $PREFIX/$git_repo"
                cscope -Rkb >& /dev/null
                ctags -R >& /dev/null
            fi
            echo "[ UPTODATE ] $PREFIX/$git_repo"
        fi
    else
        # i have no choice but update the idx
        echo "[ INDEXING ] $PREFIX/$git_repo"
        cscope -Rkb >& /dev/null
        ctags -R >& /dev/null
    fi

    popd >& /dev/null
done
